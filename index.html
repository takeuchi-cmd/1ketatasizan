<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ˆç®—åäººã¸ã®é“ï¼</title>
    <!-- Tailwind CSS ã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap');
        
        /* ã‚«ã‚¹ã‚¿ãƒ è¨­å®š */
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --secondary-color: #f59e0b; /* amber-500 */
            --success-color: #10b981; /* emerald-500 */
            --warning-color: #ef4444; /* red-500 */
        }
        
        body {
            font-family: 'Kosugi Maru', sans-serif;
            background-color: #fef3c7; /* yellow-100 */
            color: #333;
        }

        /* æ´¾æ‰‹ãªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn-primary {
            background: linear-gradient(145deg, var(--primary-color), #2563eb);
            color: white;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* ã”è¤’ç¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .celebrate {
            animation: sparkle 0.5s ease-in-out infinite;
        }

        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¹…ã‚’ç‹­ãã™ã‚‹ */
        .answer-input {
            width: 100%;
            max-width: 120px;
        }

        /* ã‚¹ã‚³ã‚¢ãƒ»ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .score-box {
            background-color: #ffffff;
            border: 4px solid var(--secondary-color);
            padding: 1rem;
        }

        /* æœ€é«˜ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .best-time-card {
            background-color: #fff7ed; /* orange-50 */
            border: 2px solid #fb923c; /* orange-400 */
            transition: all 0.3s ease;
        }

        .best-time-card:hover {
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.5);
            transform: translateY(-2px);
        }

    </style>
    <!-- Firebase SDK èª­ã¿è¾¼ã¿ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestoreã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ç¢ºèªç”¨ï¼‰
        setLogLevel('Debug');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦Firebaseé–¢é€£ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å…¬é–‹
        window.firebase = {};

        // ------------------------------------------------------------
        // â˜…â˜…â˜… å¤–éƒ¨ç’°å¢ƒï¼ˆGitHub Pagesãªã©ï¼‰ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã®è¨­å®šã‚¨ãƒªã‚¢ â˜…â˜…â˜…
        // 1. Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã€-> ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€ã§å–å¾—ã—ãŸè¨­å®šã‚’ä»¥ä¸‹ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
        //    â€» [ YOUR_... ] ã®éƒ¨åˆ†ã‚’ã€ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚„APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
        const firebaseConfig = {
  apiKey: "AIzaSy...ï¼ˆã“ã“ã«APIã‚­ãƒ¼ãŒå…¥ã‚Šã¾ã™ï¼‰",
  authDomain: "my-project-id-12345.firebaseapp.com",
  projectId: "my-project-id-12345",
  storageBucket: "my-project-id-12345.appspot.com",
  messagingSenderId: "1234567890",
  appId: "1:1234567890:web:abcdef1234567890"
};
        
        // 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å
        //    GitHub Pagesã§ã¯å…ƒã®ãƒ‘ã‚¹ãŒä½¿ãˆãªã„ãŸã‚ã€ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
        const DB_COLLECTION_NAME = 'math_records_public'; 
        const DOC_ID = 'best_times'; // æœ€é«˜ã‚¿ã‚¤ãƒ ã‚’ä¿å­˜ã™ã‚‹ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
        // ------------------------------------------------------------
        
        // æ—§Canvasç’°å¢ƒã®å¤‰æ•°ã¯ä½¿ç”¨ã—ãªã„
        const initialAuthToken = null; 
        
        let app, db, auth;
        let userId = 'loading'; // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä¿æŒ

        // èªè¨¼ã¨åˆæœŸåŒ–
        async function initializeFirebase() {
            try {
                // Firebase ConfigãŒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã§ãªã„ã‹ç¢ºèª
                if (firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                    document.getElementById('status-message').textContent = 'âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šãŒæœªå…¥åŠ›ã§ã™ã€‚Firebaseè¨­å®šæƒ…å ±ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚';
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                window.firebase.db = db;
                window.firebase.DB_COLLECTION_NAME = DB_COLLECTION_NAME;

                // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        window.firebase.userId = userId;
                        console.log("Firebase Auth: Signed in. User ID:", userId);
                        // èªè¨¼å®Œäº†å¾Œã€æœ€é«˜ã‚¿ã‚¤ãƒ ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
                        startBestTimeListener();
                    } else {
                        // å¤–éƒ¨ç’°å¢ƒã§ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä½¿ãˆãªã„ãŸã‚ã€åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’è©¦ã¿ã‚‹
                        console.log("Firebase Auth: Not signed in. Attempting anonymous sign-in...");
                        await signInAnonymously(auth);
                    }
                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                    document.getElementById('status-message').classList.add('hidden');
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                document.getElementById('status-message').textContent = `ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        // æœ€é«˜ã‚¿ã‚¤ãƒ ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function startBestTimeListener() {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }

            const docRef = doc(db, DB_COLLECTION_NAME, DOC_ID);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.updateBestTimesUI(data); // UIæ›´æ–°é–¢æ•°ã‚’å‘¼ã³å‡ºã—
                } else {
                    console.log("No initial best time record found. Creating a placeholder.");
                    // åˆå›èµ·å‹•æ™‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
                    window.updateBestTimesUI({ 
                        overallBestTime: 99999, 
                        dailyBestTime: 99999, 
                        dailyRecordDate: '' 
                    });
                }
            }, (error) => {
                console.error("Error listening to best times:", error);
                document.getElementById('status-message').textContent = 'æœ€é«˜ã‚¿ã‚¤ãƒ ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                document.getElementById('status-message').classList.remove('hidden');
            });
        }

        initializeFirebase();

        // **å¤–éƒ¨ã‹ã‚‰å‘¼ã³å‡ºã—å¯èƒ½ãªFirestoreæ›´æ–°é–¢æ•° (moduleã‚¹ã‚³ãƒ¼ãƒ—å†…)**
        window.saveBestTimes = async function(newTime) {
            if (!db) {
                console.error("Firestore is not initialized. Cannot save best times.");
                return { overallUpdated: false, dailyUpdated: false };
            }

            const now = new Date();
            const todayDate = now.toISOString().split('T')[0];
            const docRef = doc(db, DB_COLLECTION_NAME, DOC_ID);

            try {
                const docSnap = await getDoc(docRef);
                let currentData = { 
                    overallBestTime: 99999, 
                    dailyBestTime: 99999, 
                    dailyRecordDate: '' 
                };

                if (docSnap.exists()) {
                    currentData = docSnap.data();
                }

                let overallUpdated = false;
                let dailyUpdated = false;

                // ç·åˆãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã®æ›´æ–°ãƒã‚§ãƒƒã‚¯
                if (newTime < currentData.overallBestTime) {
                    currentData.overallBestTime = newTime;
                    overallUpdated = true;
                }

                // ãƒ‡ã‚¤ãƒªãƒ¼ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã®æ›´æ–°ãƒã‚§ãƒƒã‚¯
                if (currentData.dailyRecordDate !== todayDate) {
                    // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰ãƒ‡ã‚¤ãƒªãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                    currentData.dailyBestTime = newTime;
                    currentData.dailyRecordDate = todayDate;
                    dailyUpdated = true;
                } else if (newTime < currentData.dailyBestTime) {
                    // åŒã˜æ—¥ä»˜ã§ã‚ˆã‚Šé€Ÿã‘ã‚Œã°æ›´æ–°
                    currentData.dailyBestTime = newTime;
                    dailyUpdated = true;
                }

                await setDoc(docRef, currentData);
                console.log("Best times saved successfully:", currentData);

                return { overallUpdated, dailyUpdated };

            } catch (error) {
                console.error("Error updating best times in Firestore:", error);
                return { overallUpdated: false, dailyUpdated: false };
            }
        }
        
        // **å¤–éƒ¨ã‹ã‚‰å‘¼ã³å‡ºã—å¯èƒ½ãªFirestoreãƒªã‚»ãƒƒãƒˆé–¢æ•° (moduleã‚¹ã‚³ãƒ¼ãƒ—å†…)**
        window.resetBestTimes = async function() {
            if (!db) {
                console.error("Firestore is not initialized. Cannot reset.");
                return;
            }
            
            const docRef = doc(db, DB_COLLECTION_NAME, DOC_ID);
            const messageEl = document.getElementById('status-message');

            try {
                // åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆ
                await setDoc(docRef, { 
                    overallBestTime: 99999, 
                    dailyBestTime: 99999, 
                    dailyRecordDate: '' 
                });
                console.log("Best times reset successfully in Firestore.");
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ™‚çš„ã«è¡¨ç¤º
                messageEl.textContent = 'âœ… æœ€é«˜ã‚¿ã‚¤ãƒ ã®è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼';
                messageEl.classList.remove('hidden', 'text-red-600');
                messageEl.classList.add('text-green-600');
                
                setTimeout(() => {
                    // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«æˆ»ã™
                    messageEl.classList.add('hidden');
                    messageEl.classList.remove('text-green-600');
                }, 3000);

            } catch (error) {
                console.error("Error resetting best times in Firestore:", error);
                messageEl.textContent = `ğŸš¨ ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
                messageEl.classList.remove('hidden');
                messageEl.classList.add('text-red-600');
            }
        }

    </script>

</head>
<body class="p-4 flex flex-col items-center min-h-screen">

    <div id="status-message" class="text-xl text-red-600 font-bold mb-4">
        ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šä¸­...
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="app-container" class="w-full max-w-2xl bg-white p-6 rounded-3xl shadow-2xl border-4 border-yellow-500">
        
        <h1 class="text-4xl font-extrabold text-center text-blue-600 mb-6">
            ãŸã—ã–ã‚“ ã‚ã„ã˜ã‚“
        </h1>

        <!-- æœ€é«˜ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="best-time-display" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
            <div class="best-time-card p-3 rounded-xl text-center shadow-lg">
                <p class="text-sm font-semibold text-gray-700">ãã‚‡ã†ã® ã•ã„ã“ã†ã‚¿ã‚¤ãƒ </p>
                <p id="daily-best-time" class="text-3xl font-extrabold text-red-600 mt-1">--.-- ç§’</p>
            </div>
            <div class="best-time-card p-3 rounded-xl text-center shadow-lg">
                <p class="text-sm font-semibold text-gray-700">ãœã‚“ã¶ã® ã•ã„ã“ã†ã‚¿ã‚¤ãƒ </p>
                <p id="overall-best-time" class="text-3xl font-extrabold text-purple-600 mt-1">--.-- ç§’</p>
            </div>
        </div>

        <!-- ç·´ç¿’ç”»é¢ -->
        <div id="practice-screen">
            <div id="timer-display" class="text-4xl font-mono text-center mb-6 p-3 bg-gray-100 rounded-lg shadow-inner">
                0.00 ç§’
            </div>
            
            <form id="quiz-form" class="space-y-4">
                <!-- å•é¡ŒãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
            </form>

            <div class="mt-8 text-center space-y-4">
                <button id="start-button" class="btn-primary w-2/3 py-4 text-3xl rounded-full tracking-wider hover:bg-blue-700">
                    ã‚Œã‚“ã—ã‚…ã† ã‚¹ã‚¿ãƒ¼ãƒˆï¼
                </button>
                <button id="submit-button" class="btn-primary w-2/3 py-4 text-3xl rounded-full tracking-wider bg-green-500 hover:bg-green-600 hidden">
                    ã“ãŸãˆã‚’ ãŠãã‚‹ï¼
                </button>
                <!-- ç·´ç¿’ä¸­ã®ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ (ã‚‚ã©ã‚‹) -->
                <button id="reset-quiz-button" class="bg-gray-200 text-gray-700 w-1/3 py-2 text-xl rounded-full hover:bg-gray-300 transition-colors shadow-lg hidden">
                    ã‚‚ã©ã‚‹
                </button>
            </div>
        </div>

        <!-- çµæœç”»é¢ -->
        <div id="result-screen" class="text-center hidden">
            <h2 id="result-message" class="text-5xl font-black mb-4 text-success-color">
                100ç‚¹ ã ã‚ˆï¼
            </h2>
            <p class="text-2xl mb-4">ã‹ã‹ã£ãŸæ™‚é–“: <span id="final-time" class="text-red-500 font-extrabold">--.-- ç§’</span></p>
            <div id="best-time-celebration" class="text-3xl font-extrabold text-yellow-600 mb-8 celebrate hidden">
                ã•ã„ã“ã†ã‚¿ã‚¤ãƒ  ã“ã†ã—ã‚“ï¼âœ¨
            </div>
            
            <div class="score-box rounded-xl mb-8 shadow-xl">
                <p class="text-xl font-bold mb-2">ã‘ã„ã•ã‚“ã® ã›ã„ã‹ã„æ•°</p>
                <p id="correct-count" class="text-4xl font-extrabold text-blue-600">4 / 4 å•</p>
                <p class="text-xl font-bold mt-4">ã‚‚ã‚“ã ã„</p>
                <ul id="summary-list" class="text-lg space-y-1 mt-2 text-left inline-block">
                    <!-- çµæœã‚µãƒãƒªãƒ¼ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                </ul>
            </div>

            <button id="restart-button" class="btn-primary w-2/3 py-4 text-3xl rounded-full bg-blue-500 hover:bg-blue-600">
                ã‚‚ã†ã„ã¡ã© ã‚„ã‚‹ï¼
            </button>
        </div>

        <!-- æœ€é«˜ã‚¿ã‚¤ãƒ ãƒ»çµæœãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
        <div class="mt-4 text-center">
            <button id="reset-best-times-button" class="text-sm text-gray-500 hover:text-red-600 transition-colors hidden">
                æœ€é«˜ã‚¿ã‚¤ãƒ ã®è¨˜éŒ²ã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆã™ã‚‹
            </button>
        </div>

    </div>

    <!-- JavaScript ãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
        const NUM_QUESTIONS = 4;
        const practiceScreen = document.getElementById('practice-screen');
        const resultScreen = document.getElementById('result-screen');
        const startButton = document.getElementById('start-button');
        const submitButton = document.getElementById('submit-button');
        const restartButton = document.getElementById('restart-button');
        const quizForm = document.getElementById('quiz-form');
        const timerDisplay = document.getElementById('timer-display');
        const resultMessage = document.getElementById('result-message');
        const finalTimeDisplay = document.getElementById('final-time');
        const correctCountDisplay = document.getElementById('correct-count');
        const summaryList = document.getElementById('summary-list');
        const bestTimeCelebration = document.getElementById('best-time-celebration');
        const dailyBestTimeDisplay = document.getElementById('daily-best-time');
        const overallBestTimeDisplay = document.getElementById('overall-best-time');
        const resetQuizButton = document.getElementById('reset-quiz-button'); 
        const resetBestTimesButton = document.getElementById('reset-best-times-button'); 

        let quizData = [];
        let startTime = 0;
        let timerInterval = null;
        let bestTimes = { overallBestTime: 99999, dailyBestTime: 99999 };

        // =================================================================
        // 1. æœ€é«˜ã‚¿ã‚¤ãƒ UIæ›´æ–° (Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹)
        // =================================================================
        window.updateBestTimesUI = function(data) {
            // Firestoreã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
            bestTimes = {
                overallBestTime: data.overallBestTime || 99999,
                dailyBestTime: data.dailyBestTime || 99999
            };
            
            // UIè¡¨ç¤ºã®æ›´æ–°
            const formatTime = (time) => time === 99999 ? '--.-- ç§’' : `${time.toFixed(2)} ç§’`;
            
            dailyBestTimeDisplay.textContent = formatTime(bestTimes.dailyBestTime);
            overallBestTimeDisplay.textContent = formatTime(bestTimes.overallBestTime);
        };

        // =================================================================
        // 2. å•é¡Œç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (1æ¡+1æ¡ã§å’ŒãŒ10ä»¥ä¸Šã‚’ä¿è¨¼ã—ã€é‡è¤‡ã‚’é¿ã‘ã‚‹)
        //    â€»ä»¥å‰ã® generateCarryingAddition é–¢æ•°ã‚’ã“ã®ä¸­ã«çµ±åˆã—ã¾ã—ãŸã€‚
        // =================================================================
        function createQuiz() {
            quizData = [];
            quizForm.innerHTML = '';
            const usedQuestions = new Set(); // é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ã®Set (ä¾‹: "3+9")

            let i = 0;
            while (i < NUM_QUESTIONS) {
                let num1, num2;
                let normalizedQ; // å°ã•ã„æ•° + å¤§ãã„æ•°ã®å½¢å¼ã§æ­£è¦åŒ–ã—ãŸå•é¡Œæ–‡å­—åˆ— (ä¾‹: "3+9")
                
                // ç¹°ã‚Šä¸ŠãŒã‚ŠãŒã‚ã‚‹è¶³ã—ç®— (å’ŒãŒ10ä»¥ä¸Š) ã®ãƒ©ãƒ³ãƒ€ãƒ ãªå•é¡Œã‚’ç”Ÿæˆ
                do {
                    num1 = Math.floor(Math.random() * 9) + 1; // 1-9
                    num2 = Math.floor(Math.random() * 9) + 1; // 1-9
                    
                    // äº¤æ›æ³•å‰‡ã«å¯¾å¿œã™ã‚‹ãŸã‚ã€å¸¸ã«å°ã•ã„æ•° + å¤§ãã„æ•° ã®å½¢å¼ã§æ­£è¦åŒ–
                    const minNum = Math.min(num1, num2);
                    const maxNum = Math.max(num1, num2);
                    normalizedQ = `${minNum}+${maxNum}`;

                } while (num1 + num2 < 10 || usedQuestions.has(normalizedQ)); // å’ŒãŒ10æœªæº€ ã¾ãŸã¯ é‡è¤‡ã—ã¦ã„ãŸã‚‰å†ç”Ÿæˆ
                
                // é‡è¤‡ãŒãªã‘ã‚Œã°æ¡ç”¨
                usedQuestions.add(normalizedQ);

                const q = { 
                    id: `q${i}`, 
                    question: `${num1} + ${num2}`, // å®Ÿéš›ã®è¡¨ç¤ºã¯ãƒ©ãƒ³ãƒ€ãƒ ãªé †åº (ä¾‹: 9 + 3)
                    answer: num1 + num2 
                };
                quizData.push(q);

                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-yellow-50 rounded-xl shadow-md border-2 border-yellow-300';
                div.innerHTML = `
                    <label for="${q.id}" class="text-3xl font-bold text-gray-800">${i + 1}. ${q.question} =</label>
                    <input type="number" id="${q.id}" name="${q.id}" min="10" max="18" required 
                           class="answer-input text-3xl p-3 border-4 border-blue-400 rounded-lg text-center font-mono focus:ring-4 focus:ring-blue-300"
                           placeholder="ï¼Ÿ">
                `;
                quizForm.appendChild(div);
                
                i++; // å•é¡ŒãŒç¢ºå®šã—ãŸã‚‰ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
            }
        }

        // =================================================================
        // 3. ã‚¿ã‚¤ãƒãƒ¼åˆ¶å¾¡
        // =================================================================
        function startTimer() {
            startTime = Date.now();
            timerDisplay.textContent = '0.00 ç§’';

            // 0.01ç§’ã”ã¨ã«æ›´æ–°
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                timerDisplay.textContent = `${elapsed.toFixed(2)} ç§’`;
            }, 10);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            const endTime = Date.now();
            return (endTime - startTime) / 1000;
        }

        // =================================================================
        // 4. ç”»é¢ãƒ»ãƒœã‚¿ãƒ³åˆ¶å¾¡
        // =================================================================
        function showScreen(screenId) {
            practiceScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }

        function resetGame() {
            stopTimer(); // ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
            timerDisplay.textContent = '0.00 ç§’';
            submitButton.classList.add('hidden');
            resetQuizButton.classList.add('hidden'); // ç·´ç¿’ä¸­ã®ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            startButton.classList.remove('hidden');
            bestTimeCelebration.classList.add('hidden');
            bestTimeCelebration.classList.remove('celebrate');
            quizForm.innerHTML = ''; // å•é¡Œã‚’ã‚¯ãƒªã‚¢
            showScreen('practice-screen');
            
            // æœ€é«˜ã‚¿ã‚¤ãƒ ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            resetBestTimesButton.classList.remove('hidden');
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        startButton.addEventListener('click', () => {
            createQuiz();
            startTimer();
            startButton.classList.add('hidden');
            submitButton.classList.remove('hidden');
            resetQuizButton.classList.remove('hidden'); // ç·´ç¿’ä¸­ã®ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            // æœ€é«˜ã‚¿ã‚¤ãƒ ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            resetBestTimesButton.classList.add('hidden'); 
            // æœ€åˆã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            document.getElementById(quizData[0].id)?.focus(); 
        });

        // ç·´ç¿’ä¸­ã®ã€Œã‚‚ã©ã‚‹ã€ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ (ãƒªã‚»ãƒƒãƒˆ)
        resetQuizButton.addEventListener('click', () => {
            resetGame();
        });

        // =================================================================
        // 5. å›ç­”ãƒã‚§ãƒƒã‚¯ã¨çµæœå‡¦ç†
        // =================================================================
        submitButton.addEventListener('click', (e) => {
            e.preventDefault();
            const finalTime = stopTimer();
            // submitå¾Œã¯ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã¯éè¡¨ç¤º
            resetQuizButton.classList.add('hidden'); 
            processResults(finalTime);
            showScreen('result-screen');
        });

        // çµæœç”»é¢ã®ã€Œã‚‚ã†ã„ã¡ã©ã‚„ã‚‹ã€ãƒœã‚¿ãƒ³ (ãƒªã‚»ãƒƒãƒˆ)
        restartButton.addEventListener('click', () => {
            resetGame();
        });

        async function processResults(finalTime) {
            let overallUpdated = false;
            let dailyUpdated = false;
            let correctCount = 0;
            summaryList.innerHTML = '';

            // 1. æ¡ç‚¹ã¨ã‚µãƒãƒªãƒ¼ä½œæˆ
            quizData.forEach((q, index) => {
                const input = document.getElementById(q.id);
                // å…¥åŠ›ãŒç©ºã ã£ãŸå ´åˆã‚’è€ƒæ…®ã—ã€0ã¨ã—ã¦æ‰±ã†
                const userAnswer = parseInt(input.value) || 0; 
                const isCorrect = userAnswer === q.answer;

                if (isCorrect) {
                    correctCount++;
                }

                const listItem = document.createElement('li');
                listItem.className = 'flex justify-between items-center';
                const icon = isCorrect 
                    ? `<span class="text-green-500 text-2xl">âœ¨</span>` 
                    : `<span class="text-red-500 text-2xl">âŒ</span>`;
                
                listItem.innerHTML = `
                    ${icon} 
                    <span class="ml-2">${q.question} = </span>
                    <span class="font-bold mr-2 ${isCorrect ? 'text-green-600' : 'text-red-600'}">${userAnswer}</span>
                    <span class="text-sm text-gray-500">ï¼ˆæ­£è§£: ${q.answer}ï¼‰</span>
                `;
                summaryList.appendChild(listItem);
            });

            // 2. ã‚¹ã‚³ã‚¢è¡¨ç¤º
            finalTimeDisplay.textContent = finalTime.toFixed(2);
            correctCountDisplay.textContent = `${correctCount} / ${NUM_QUESTIONS} å•`;

            // 3. ã”è¤’ç¾ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (correctCount === NUM_QUESTIONS) {
                // 100ç‚¹ã®å ´åˆã€æœ€é«˜ã‚¿ã‚¤ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€Firestoreã«ä¿å­˜
                resultMessage.textContent = 'ğŸ’¯ 100ç‚¹ ã ã‚ˆï¼ ã™ã”ã„ï¼ ğŸ’¯';
                resultMessage.className = 'text-5xl font-black mb-4 text-success-color celebrate';
                
                if (window.saveBestTimes) {
                    // window.saveBestTimes ã¯ moduleã‚¹ã‚³ãƒ¼ãƒ—å†…ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹
                    const updateResult = await window.saveBestTimes(finalTime);
                    overallUpdated = updateResult.overallUpdated;
                    dailyUpdated = updateResult.dailyUpdated;
                }
                
            } else {
                // 100ç‚¹ã§ã¯ãªã„å ´åˆ
                resultMessage.textContent = 'ã‚‚ã†ã™ã“ã—ï¼ ãŒã‚“ã°ã‚ã†ï¼';
                resultMessage.className = 'text-5xl font-black mb-4 text-warning-color';
            }

            // 4. æœ€é«˜ã‚¿ã‚¤ãƒ æ›´æ–°æ™‚ã®æ¼”å‡º
            if (overallUpdated || dailyUpdated) {
                let message = '';
                if (overallUpdated) {
                    message = 'ãœã‚“ã¶ã® ã•ã„ã“ã†ã‚¿ã‚¤ãƒ  ã“ã†ã—ã‚“ï¼ğŸ‘‘âœ¨';
                } else if (dailyUpdated) {
                    message = 'ãã‚‡ã†ã® ã•ã„ã“ã†ã‚¿ã‚¤ãƒ  ã“ã†ã—ã‚“ï¼ğŸ‰';
                }
                
                bestTimeCelebration.textContent = message;
                bestTimeCelebration.classList.remove('hidden');
                bestTimeCelebration.classList.add('celebrate');
                
            } else {
                bestTimeCelebration.classList.add('hidden');
                bestTimeCelebration.classList.remove('celebrate');
            }
        }
        
        // =================================================================
        // 6. æœ€é«˜ã‚¿ã‚¤ãƒ ã¨çµæœã®ãƒªã‚»ãƒƒãƒˆ
        // =================================================================
        
        // æœ€é«˜ã‚¿ã‚¤ãƒ ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        resetBestTimesButton.addEventListener('click', () => {
            // window.resetBestTimes ã¯ moduleã‚¹ã‚³ãƒ¼ãƒ—å†…ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹
            if (window.resetBestTimes) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ˜ç¢ºãªãƒªã‚»ãƒƒãƒˆè¦æ±‚ã¨è¦‹ãªã—ã€ç¢ºèªãªã—ã§å®Ÿè¡Œ
                window.resetBestTimes();
                // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹
                resetGame();
            } else {
                 document.getElementById('status-message').textContent = 'ğŸš¨ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå¾…ã¡ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                 document.getElementById('status-message').classList.remove('hidden');
            }
        });


        // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
        document.addEventListener('DOMContentLoaded', resetGame);

    </script>
</body>
</html>